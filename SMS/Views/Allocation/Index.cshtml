<div class="myTabs">
    <ul class="nav nav-tabs" id="main-tab" role="tablist">
        <li class="nav-item allocation-list" role="presentation">
            <button class="nav-link active" id="first-tab" data-bs-toggle="tab" data-bs-target="#tab-one-content" area-selected="true">Teacher Subject Allocation</button>
        </li>
        <li class="nav-item allocation-list" role="presentation">
            <button class="nav-link" id="second-tab" data-bs-toggle="tab" data-bs-target="#tab-two-content" area-selected="false">Student Subject Teacher Allocation</button>
        </li>
    </ul>
</div>
<div class="panel panel-default full-body">
    <div class="container-fluid"> 
        
        <div class="tab-content" id="TabContent">
            @* teacher subject allocation div *@
            <div class="tab-pane show active allocationContent" id="tab-one-content" role="tabpanel" aria-labelledby="first-tab">
                <div class="panel container-fluid mb-5">
                    <div class="main-heading">
                        <h2> Teacher Subject Allocation</h2>
                        

                    </div>
                    <div class="panel-heading d-flex align-items-center justify-content-between">
                        <div>
                            <button id="addNew" class="btn me-3 text-light addNew1">Add New Allocation</button>
                        </div>

                    </div>
                </div>

                <div class="table-responsive" id="table-datails-teachers">
                    <table id="subjectAllocationTable" class="table table-bordered table-striped">
                        <thead class="text-center tableHeading">
                            <tr>
                                <th class="sorting">Subject Code</th>
                                <th class="sorting">Subject Name</th>
                                <th class="sorting">Teacher Registration No</th>
                                <th class="sorting">Teacher Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-center" id="teacherSubjectAllocationTable"></tbody>

                    </table>

                    <div class="addEdit">
                        <div id="addTeacherSubjectAllocationForm" class="container-fluid" style="display: none;">
                            
                        </div>
                    </div>



                </div>


            </div>

            @* Students subject allocation div *@
        <div class="tab-pane show allocationContent" id="tab-two-content" role="tabpanel" aria-labelledby="second-tab">
            <div class="panel container-fluid mb-5">
                <div class="text-center">
                    <h2 class="mb-5"> Student Subject Teacher Allocation</h2>

                </div>
                <div class="panel-heading d-flex align-items-center justify-content-between">
                    <div>
                        <button id="addNew" class="btn me-3 text-light addNew2">Add New Allocation</button>
                    </div>

                </div>
            </div>

            <div class="table-responsive" id="table-datails-students">
                <table id="studentAllocationTable" class="table table-bordered table-striped">
                    <thead class="text-center tableHeading">
                        <tr>
                            <th class="sorting">Student Registration Number</th>
                            <th class="sorting">Student Name</th>
                            <th class="sorting">Subject Code</th>
                            <th class="sorting">Subject Name</th>
                            <th class="sorting">Teacher Registration No</th>
                            <th class="sorting">Teacher Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-center" id="studentAllocationTableBody"></tbody>

                </table>
                <div class="addEdit">
                    <div id="addStudentAllocationForm" class="container-fluid" style="display: none;">
                        
                    </div>
                </div>

            </div>
           

        </div>
        </div>
    </div>
</div>









@section Scripts{
    <script>
        $(document).ready(function () {
            loadSubjectTeacherAllocationData();

            $('input[type=text], input[type=email], select').each(function () {
                var req = $(this).attr('data-val-required');
                if (undefined != req) {
                    var label = $('label[for="' + $(this).attr('id') + '"]');
                    var text = label.text();
                    if (text.length > 0) {
                        label.append('<span style="color:red"> *</span>');
                    }
                }
            });


            $('.addNew1').click(function () {
                $('.addNew1').hide();
                $('#subjectAllocationTable').hide();
                $.ajax({
                    url: '/Allocation/AddTeacherSubjectAllocation',
                    type: 'GET',
                    success: function (response) {
                        $('#addTeacherSubjectAllocationForm').html(response);
                        $.validator.unobtrusive.parse($('#addTeacherSubjectAllocationForm'));
                        $('#addTeacherSubjectAllocationForm').show();

                    }
                });
            });

            //For Student Allocation
            loadStudentAllocationData();

            //Subject Teachers
            $('.addNew2').click(function () {
                $('.addNew2').hide();
                $('#studentAllocationTable').hide();               
                $.ajax({
                    url: '/Allocation/AddStudentAllocation',
                    type: 'GET',
                    success: function (response) {
                        $('#addStudentAllocationForm').html(response);
                        activeSubjectTeacher();
                        $.validator.unobtrusive.parse($('#addStudentAllocationForm'));
                        $('#addStudentAllocationForm').show();

                    }
                });

            });

            


        });


        //For Teacher Allocation
        function loadSubjectTeacherAllocationData() {
            $.ajax({
                url: '/Allocation/AllSubjectTeacherAllocation',
                type: 'GET',
                success: function (data) {
                    if (data.success) {
                        $('#teacherSubjectAllocationTable').empty();


                        $.each(data.data, function (index, item) {
                            var row = $('<tr>').appendTo('#teacherSubjectAllocationTable');
                            $('<td>').text(item.SubjectCode).appendTo(row);
                            $('<td>').text(item.SubjectName).appendTo(row);
                            $('<td>').text(item.TeacherRegNo).appendTo(row);
                            $('<td>').text(item.TeacherName).appendTo(row);


                            var actionCell = $('<td>').appendTo(row);
                            var editButton = $('<button>').addClass('btn btn-primary btn-sm').appendTo(actionCell);
                            editButton.append($('<i>').addClass('bi bi-pencil-fill'));
                            editButton.click(function () {
                                editTeacherSubjectAllocation(item.SubjectAllocationID);
                            });

                            var deleteButton = $('<button>').addClass('btn btn-danger btn-sm').appendTo(actionCell);
                            deleteButton.append($('<i>').addClass('bi bi-trash'));
                            deleteButton.click(function () {
                                deleteTeacherSubjectAllocation(item.SubjectAllocationID);
                            });


                        });
                    } else {

                        $('#teacherSubjectAllocationTable').html('<tr><td colspan="4">' + data.message + '</td></tr>');
                    }
                },
                error: function () {

                    console.error('Failed to load data.');
                }
            });
        }


        function addTeacherSubjectAllocationSuccess(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: response.message,
                    showCancelButton: false,
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {

                        loadSubjectTeacherAllocationData();
                        $('#addTeacherSubjectAllocationForm').hide();
                        $('#addTeacherSubjectAllocationForm').find('input[type=text], select').val(''); 
                        $('#subjectAllocationTable').show();
                        $('.addNew1').show();

                        


                    }
                });
            } else {
                Swal.fire({ icon: 'warning', title: 'Allert', text: response.message });
            }
        }


        function addTeacherSubjectAllocationFailure(error) {
            console.log(error);
            Swal.fire('Allert!', 'An error occurred while adding the teacher.', 'worning');
        }

        function backTeacher() {
            $('#addTeacherSubjectAllocationForm').hide();
            $('#addTeacherSubjectAllocationForm').find('input[type=text], select').val('');
            $('#subjectAllocationTable').show();
            
            $('.addNew1').show();
            

        }

        function backStudent() {
            $('#addStudentAllocationForm').hide();
            $('#addStudentAllocationForm').find('input[type=text], select').val('');
            $('#studentAllocationTable').show();
            $('.addNew2').show();



        }

        function deleteTeacherSubjectAllocation(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Allocation/DeleteTeacherSubjectAllocation/' + id,
                        type: 'POST',
                        success: function (response) {
                            if (response.success) {
                                $('#tableBody tr:has(td:contains(' + id + '))').remove();
                                loadSubjectTeacherAllocationData();
                                Swal.fire('Deleted!', 'Record deleted successfully.', 'success');

                            } else {
                                Swal.fire('Allert!', response.message, 'warning');
                            }
                        },
                        error: function (error) {
                            console.log(error);
                            Swal.fire('Alert!', 'An error occurred while deleting the teacher.', 'warning');
                        }
                    });
                }
            });
        }

        function editTeacherSubjectAllocation(id) {
            $.ajax({
                url: '/Allocation/AddTeacherSubjectAllocation/' + id,
                type: 'GET',
                success: function (data) {
                    $('#addTeacherSubjectAllocationForm').html(data);
                    $('#subjectAllocationTable').hide();
                    $('#addTeacherSubjectAllocationForm').show();
                    $('.addNew1').hide();

                },
                error: function (error) {
                    console.log(error);
                    Swal.fire('Alert!', 'An error occurred while fetching teacher details.', 'warning');
                }

            });

        }

        
        //For Students Allocation

        function loadStudentAllocationData() {
            $.ajax({
                url: '/Allocation/AllStudentAllocation',
                type: 'GET',
                success: function (data) {
                    if (data.success) {
                        $('#studentAllocationTableBody').empty();


                        $.each(data.data, function (index, item) {
                            var row = $('<tr>').appendTo('#studentAllocationTableBody');
                            $('<td>').text(item.studentRegNo).appendTo(row);
                            $('<td>').text(item.StudentName).appendTo(row);
                            $('<td>').text(item.subjectCode).appendTo(row);
                            $('<td>').text(item.SubjectName).appendTo(row);
                            $('<td>').text(item.teacherRegNo).appendTo(row);
                            $('<td>').text(item.TeacherName).appendTo(row);


                            var actionCell = $('<td>').appendTo(row);
                            var editButton = $('<button>').addClass('btn btn-primary btn-sm').appendTo(actionCell);
                            editButton.append($('<i>').addClass('bi bi-pencil-fill'));
                            editButton.click(function () {
                                editStudentAllocation(item.studentAllocationID);
                            });

                            var deleteButton = $('<button>').addClass('btn btn-danger btn-sm').appendTo(actionCell);
                            deleteButton.append($('<i>').addClass('bi bi-trash'));
                            deleteButton.click(function () {
                                deleteStudentAllocation(item.studentAllocationID);
                            });


                        });
                    } else {

                        $('#studentAllocationTable').html('<tr><td colspan="4">' + data.message + '</td></tr>');
                    }
                },
                error: function () {

                    console.error('Failed to load data.');
                }
            });
        }


        //Available subject and teacher
        function activeSubjectTeacher() {
            $.ajax({
                url: '/Allocation/GetAllocatedSubject',
                type: 'GET',
                success: function (response) {
                    $('#subjectDropdown').empty().append($('<option>', {
                        value: '',
                        text: 'Select Subject'
                    }));
                    $('#teacherDropdown').empty().append($('<option>', {
                        value: '',
                        text: 'Select Teacher'
                    }));

                    if (response.success) {
                        $.each(response.data, function (index, item) {
                            $('#subjectDropdown').append($('<option>', {
                                value: item.SubjectID,
                                text: item.Name
                            }));
                        });
                    } else {
                        console.log('No data found.');
                    }
                },
                error: function () {
                    console.log('Error fetching allocated subjects.');
                }
            });
        }

        

        //Add Student allocation
        function addStudentAllocationSuccess(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: response.message,
                    showCancelButton: false,
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {
                        loadStudentAllocationData();
                        $('#addStudentAllocationForm').hide();
                        $('#subjectAllocationID').val('');
                        $('#addStudentAllocationForm').find('select').val('');
                        $('#studentAllocationTable').show();
                        $('.addNew2').show();
                        $('#addStudentAllocationForm').hide();
                        $('#studentAllocationTable').show();
                       
                    }
                });
            } else {
                Swal.fire({ icon: 'warning', title: '', text: response.message, error: response.error });
            }
        }

        function addStudentAllocationFailure(xhr, status, error) {
            console.error("Error adding teacher subject allocation:", error);
            Swal.fire('Alert!', 'An error occurred while adding the teacher subject allocation.', 'warning');
        }

        function deleteStudentAllocation(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Allocation/DeleteStudentAllocation/' + id,
                        type: 'POST',
                        success: function (response) {
                            if (response.success) {
                                $('#studentAllocationTableBody tr:has(td:contains(' + id + '))').remove();
                                loadStudentAllocationData();
                                Swal.fire('Deleted!', 'Record deleted successfully.', 'success');

                            } else {
                                Swal.fire('Alert!', response.message, 'warning');
                            }
                        },
                        error: function (error) {
                            console.log(error);
                            Swal.fire('Alert!', 'An error occurred while deleting the teacher.', 'warning');
                        }
                    });
                }
            });
        }


        

        //editSubjectAllocation
        function editStudentAllocation(studentAllocationID) {
            $.ajax({
                url: '/Allocation/AddStudentAllocation/' + studentAllocationID,
                type: 'GET',
                success: function (data) {
                    $('#addStudentAllocationForm').html(data);
                    $('#addStudentAllocationForm').show();
                    
                    $.ajax({
                        url: '/Allocation/GetAllocatedSubject',
                        type: 'GET',
                        success: function (response) {
                            if (response.success) {
                                $.each(response.data, function (index, item) {
                                    $('#subjectDropdown').append($('<option>', {
                                        value: item.SubjectID,
                                        text: item.Name
                                    }));
                                });
                            } else {
                                console.log('No data found.');
                            }
                        },
                        error: function () {
                            console.log('Error fetching allocated subjects.');
                        }
                    });
                    $.validator.unobtrusive.parse($('#addStudentAllocationForm'));
                    $('#studentAllocationTable').hide();                   
                    $('.addNew2').hide();
                },
                error: function (error) {
                    console.log(error);
                    Swal.fire('Alert!', 'An error occurred while fetching student allocation details.', 'warning');
                }
            });
        }

        








    </script>
}










